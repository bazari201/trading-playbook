<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Playbook Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0a0e27; --bg-secondary: #141936; --bg-card: #1a1f3a;
            --accent-primary: #00d4ff; --accent-secondary: #7c3aed; --accent-success: #10b981;
            --accent-danger: #ef4444; --text-primary: #e2e8f0; --text-secondary: #94a3b8;
            --border-color: #2d3558; --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        body {
            font-family: 'Poppins', sans-serif; background: var(--bg-primary); color: var(--text-primary);
            line-height: 1.6; min-height: 100vh;
            background-image: radial-gradient(at 20% 30%, rgba(124, 58, 237, 0.15) 0px, transparent 50%),
                              radial-gradient(at 80% 70%, rgba(0, 212, 255, 0.15) 0px, transparent 50%);
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            background: var(--bg-secondary); padding: 20px 30px; border-radius: 16px; margin-bottom: 30px;
            border: 1px solid var(--border-color); display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; gap: 20px;
        }
        .header-title { display: flex; align-items: center; gap: 15px; }
        .logo {
            width: 50px; height: 50px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 24px;
        }
        h1 {
            font-size: 28px; font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .sync-status {
            display: flex; align-items: center; gap: 10px; padding: 10px 20px;
            background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color);
            font-size: 14px;
        }
        .sync-indicator {
            width: 10px; height: 10px; border-radius: 50%; background: var(--accent-success);
            animation: pulse 2s infinite;
        }
        .sync-indicator.disconnected { background: var(--accent-danger); animation: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab {
            padding: 12px 24px; background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 10px; cursor: pointer; transition: all 0.3s ease; font-weight: 500;
        }
        .tab:hover { background: var(--bg-card); transform: translateY(-2px); }
        .tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-color: transparent; color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card {
            background: var(--bg-secondary); border-radius: 16px; padding: 25px; margin-bottom: 20px;
            border: 1px solid var(--border-color); box-shadow: var(--shadow);
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
            padding-bottom: 15px; border-bottom: 1px solid var(--border-color);
        }
        .card-title { font-size: 20px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;
            font-size: 14px; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 212, 255, 0.3); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary {
            background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color);
        }
        .btn-secondary:hover { background: var(--bg-primary); }
        .btn-success { background: var(--accent-success); color: white; }
        .btn-danger { background: var(--accent-danger); color: white; }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-card); padding: 20px; border-radius: 12px;
            border: 1px solid var(--border-color); text-align: center;
        }
        .stat-value {
            font-size: 32px; font-weight: 700; font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .stat-label { font-size: 14px; color: var(--text-secondary); margin-top: 8px; }
        .toast {
            position: fixed; bottom: 30px; right: 30px; padding: 16px 24px;
            background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4); display: none; align-items: center;
            gap: 12px; z-index: 2000; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
        .toast.active { display: flex; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">
                <div class="logo">TP</div>
                <div>
                    <h1>Trading Playbook Pro</h1>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-top: 5px;">Cloud-Synced Trading Journal</p>
                </div>
            </div>
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div class="sync-status">
                    <div class="sync-indicator disconnected" id="syncIndicator"></div>
                    <span id="syncStatus">Not Connected</span>
                </div>
                <button class="btn btn-primary" id="authButton" onclick="handleAuthClick()" disabled>
                    <span>üîê</span> Connect Google Sheets
                </button>
                <button class="btn btn-success" id="syncButton" onclick="syncToGoogleSheets()" style="display: none;">
                    <span>‚òÅ</span> Sync Now
                </button>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="switchTab(event, 'dashboard')">üìä Dashboard</div>
            <div class="tab" onclick="switchTab(event, 'trades')">üí∞ My Trades</div>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalTrades">0</div>
                    <div class="stat-label">Total Trades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="winRate">0%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPnL">‚Çπ0</div>
                    <div class="stat-label">Total P&L</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgPnL">‚Çπ0</div>
                    <div class="stat-label">Avg P&L per Trade</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìà Recent Activity</div>
                </div>
                <div id="recentActivity">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">
                        No recent activity. Start by connecting Google Sheets or adding trades locally.
                    </p>
                </div>
            </div>
        </div>

        <div id="trades" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üí∞ Trade History</div>
                    <button class="btn btn-primary" onclick="addSampleTrade()">+ Add Sample Trade</button>
                </div>
                <div id="tradesList">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">
                        No trades yet. Click "Add Sample Trade" to get started!
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

    <!-- FIXED: Google Sheets API with proper onload callbacks -->
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    
    <script>
        const CLIENT_ID = '882695139495-nhsbdo81onntkvla5h0ukq16fatnf392.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBs0O66sO0d8Xy2GeWjYfgnveutSYu8p08';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        let tokenClient, gapiInited = false, gisInited = false, spreadsheetId = null;
        let appData = { trades: [], settings: {} };

        function gapiLoaded() {
            console.log('üì¶ GAPI loaded');
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                    gapiInited = true;
                    console.log('‚úÖ GAPI initialized');
                    maybeEnableButtons();
                } catch (error) {
                    console.error('‚ùå GAPI error:', error);
                }
            });
        }

        function gisLoaded() {
            console.log('üì¶ GIS loaded');
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, scope: SCOPES, callback: ''
                });
                gisInited = true;
                console.log('‚úÖ GIS initialized');
                maybeEnableButtons();
            } catch (error) {
                console.error('‚ùå GIS error:', error);
            }
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                console.log('‚úÖ APIs ready - button enabled');
                document.getElementById('authButton').disabled = false;
                updateSyncStatus(false, 'Not Connected');
            }
        }

        function handleAuthClick() {
            console.log('üîê Auth clicked');
            if (!tokenClient) {
                showToast('Error: API not loaded');
                return;
            }

            tokenClient.callback = async (resp) => {
                if (resp.error) {
                    console.error('‚ùå Auth error:', resp);
                    showToast('Authentication failed');
                    return;
                }
                
                console.log('‚úÖ Authenticated');
                updateSyncStatus(true, 'Connected');
                document.getElementById('authButton').style.display = 'none';
                document.getElementById('syncButton').style.display = 'inline-flex';
                
                await initializeSpreadsheet();
                await syncToGoogleSheets();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function initializeSpreadsheet() {
            try {
                if (appData.settings.spreadsheetId) {
                    spreadsheetId = appData.settings.spreadsheetId;
                    return;
                }

                const response = await gapi.client.sheets.spreadsheets.create({
                    properties: { title: 'Trading Playbook - ' + new Date().toLocaleDateString() },
                    sheets: [{properties: {title: 'Trades'}}]
                });

                spreadsheetId = response.result.spreadsheetId;
                appData.settings.spreadsheetId = spreadsheetId;
                saveData();

                console.log('‚úÖ Sheet created:', spreadsheetId);
                showToast('‚úÖ Google Sheet created!');
            } catch (error) {
                console.error('‚ùå Create error:', error);
                showToast('Error creating spreadsheet');
            }
        }

        async function syncToGoogleSheets() {
            if (!spreadsheetId) {
                showToast('Please connect first');
                return;
            }

            try {
                console.log('‚òÅÔ∏è Syncing...');
                updateSyncStatus(true, 'Syncing...');

                const tradesData = [['Symbol', 'Type', 'Quantity', 'Price', 'Date', 'P&L']];
                appData.trades.forEach(trade => {
                    tradesData.push([
                        trade.symbol, trade.type, trade.quantity,
                        trade.price, trade.date, trade.pnl
                    ]);
                });

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: spreadsheetId,
                    range: 'Trades!A1',
                    valueInputOption: 'RAW',
                    resource: { values: tradesData }
                });

                appData.settings.lastSync = new Date().toISOString();
                saveData();

                updateSyncStatus(true, 'Synced - ' + new Date().toLocaleTimeString());
                showToast('‚úÖ Synced to Google Sheets!');
                
                console.log('üîó Sheet:', `https://docs.google.com/spreadsheets/d/${spreadsheetId}`);
            } catch (error) {
                console.error('‚ùå Sync error:', error);
                showToast('‚ùå Sync failed');
                updateSyncStatus(false, 'Sync Failed');
            }
        }

        function updateSyncStatus(connected, message) {
            const indicator = document.getElementById('syncIndicator');
            const status = document.getElementById('syncStatus');
            if (connected) {
                indicator.classList.remove('disconnected');
                status.textContent = message;
            } else {
                indicator.classList.add('disconnected');
                status.textContent = message;
            }
        }

        function switchTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function addSampleTrade() {
            const trade = {
                id: Date.now(),
                symbol: 'RELIANCE',
                type: 'BUY',
                quantity: 100,
                price: 2500.50,
                date: new Date().toISOString().split('T')[0],
                pnl: 12500
            };

            appData.trades.unshift(trade);
            saveData();
            renderTrades();
            updateDashboard();
            showToast('‚úÖ Sample trade added!');
        }

        function renderTrades() {
            const container = document.getElementById('tradesList');
            if (appData.trades.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No trades yet.</p>';
                return;
            }

            container.innerHTML = appData.trades.map(trade => `
                <div style="background: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div><div style="font-size: 12px; color: var(--text-secondary);">SYMBOL</div><div style="font-weight: 600;">${trade.symbol}</div></div>
                        <div><div style="font-size: 12px; color: var(--text-secondary);">TYPE</div><div style="font-weight: 600;">${trade.type}</div></div>
                        <div><div style="font-size: 12px; color: var(--text-secondary);">QTY</div><div style="font-weight: 600;">${trade.quantity}</div></div>
                        <div><div style="font-size: 12px; color: var(--text-secondary);">PRICE</div><div style="font-weight: 600;">‚Çπ${trade.price}</div></div>
                        <div><div style="font-size: 12px; color: var(--text-secondary);">P&L</div><div style="font-weight: 600; color: ${trade.pnl >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'};">${trade.pnl >= 0 ? '+' : ''}‚Çπ${trade.pnl}</div></div>
                    </div>
                </div>
            `).join('');
        }

        function updateDashboard() {
            const total = appData.trades.length;
            document.getElementById('totalTrades').textContent = total;

            if (total > 0) {
                const profitable = appData.trades.filter(t => t.pnl > 0).length;
                const winRate = ((profitable / total) * 100).toFixed(1);
                document.getElementById('winRate').textContent = winRate + '%';

                const totalPnL = appData.trades.reduce((sum, t) => sum + (t.pnl || 0), 0);
                document.getElementById('totalPnL').textContent = '‚Çπ' + totalPnL.toFixed(2);

                const avgPnL = (totalPnL / total).toFixed(2);
                document.getElementById('avgPnL').textContent = '‚Çπ' + avgPnL;
            }
        }

        function saveData() {
            localStorage.setItem('tradingPlaybookData', JSON.stringify(appData));
        }

        function loadData() {
            const saved = localStorage.getItem('tradingPlaybookData');
            if (saved) {
                appData = JSON.parse(saved);
                if (!appData.trades) appData.trades = [];
                if (!appData.settings) appData.settings = {};
                spreadsheetId = appData.settings.spreadsheetId;
                renderTrades();
                updateDashboard();
                
                if (spreadsheetId && gapiInited && gisInited && gapi.client.getToken()) {
                    document.getElementById('authButton').style.display = 'none';
                    document.getElementById('syncButton').style.display = 'inline-flex';
                    updateSyncStatus(true, 'Connected');
                }
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        window.onload = function() {
            console.log('üöÄ App loading...');
            loadData();
            console.log('üìä Data loaded');
        };
    </script>
</body>
</html>
