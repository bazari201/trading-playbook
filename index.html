<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Playbook Pro - Multi-User Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #141936;
            --bg-card: #1a1f3a;
            --accent-primary: #00d4ff;
            --accent-secondary: #7c3aed;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #2d3558;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            background-image: 
                radial-gradient(at 20% 30%, rgba(124, 58, 237, 0.15) 0px, transparent 50%),
                radial-gradient(at 80% 70%, rgba(0, 212, 255, 0.15) 0px, transparent 50%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--bg-secondary);
            padding: 20px 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 24px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 14px;
        }

        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-success);
            animation: pulse 2s infinite;
        }

        .sync-indicator.disconnected {
            background: var(--accent-danger);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab:hover {
            background: var(--bg-card);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-color: transparent;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
        }

        .btn-success {
            background: var(--accent-success);
            color: white;
        }

        .btn-danger {
            background: var(--accent-danger);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'JetBrains Mono', monospace;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            flex: 1;
            font-size: 14px;
        }

        .trade-list {
            display: grid;
            gap: 15px;
        }

        .trade-item {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: start;
            transition: all 0.3s ease;
        }

        .trade-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(5px);
        }

        .trade-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .trade-field-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .trade-field-value {
            font-size: 16px;
            font-weight: 500;
            font-family: 'JetBrains Mono', monospace;
        }

        .trade-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-buy {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-success);
        }

        .badge-sell {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-danger);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .file-upload {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-card);
        }

        .file-upload:hover {
            border-color: var(--accent-primary);
            background: var(--bg-primary);
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .close-modal {
            cursor: pointer;
            font-size: 28px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--accent-danger);
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .toast.active {
            display: flex;
        }

        .commentary-entry {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--accent-primary);
            margin-bottom: 15px;
        }

        .commentary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .commentary-date {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .commentary-text {
            line-height: 1.8;
            color: var(--text-primary);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .setup-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .setup-card:hover {
            border-color: var(--accent-primary);
        }

        .setup-card.ready-for-trade {
            border-color: var(--accent-success);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.1));
        }

        .setup-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .setup-title-section h3 {
            margin-bottom: 8px;
            font-size: 20px;
        }

        .setup-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .setup-status {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .setup-status.ready {
            background: var(--accent-success);
            color: white;
            animation: pulse-glow 2s infinite;
        }

        .setup-status.pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            }
            50% { 
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
            }
        }

        .setup-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .entry-criteria-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .entry-criteria-item {
            display: flex;
            align-items: start;
            gap: 12px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .entry-criteria-item:hover {
            background: var(--bg-secondary);
        }

        .entry-criteria-item.completed {
            border-color: var(--accent-success);
            background: rgba(16, 185, 129, 0.05);
        }

        .entry-criteria-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-success);
            margin-top: 2px;
        }

        .entry-criteria-text {
            flex: 1;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .criteria-delete {
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .criteria-delete:hover {
            background: var(--accent-danger);
            color: white;
        }

        .add-criteria-btn {
            width: 100%;
            padding: 12px;
            background: var(--bg-primary);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            margin-top: 10px;
        }

        .add-criteria-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: var(--bg-card);
        }

        .trade-instance-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .trade-instance-card:hover {
            border-color: var(--accent-primary);
            transform: translateX(5px);
        }

        .trade-instance-card.ready {
            border-color: var(--accent-success);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.1));
        }

        .trade-instance-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .trade-instance-info {
            flex: 1;
        }

        .trade-instance-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .trade-instance-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .trade-instance-date {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-primary);
        }

        .trade-instance-actions {
            display: flex;
            gap: 10px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid;
        }

        .alert-info {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--accent-success);
            color: var(--accent-success);
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            border-color: #ffc107;
            color: #ffc107;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">
                <div class="logo">TP</div>
                <div>
                    <h1>Trading Playbook Pro</h1>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-top: 5px;">Cloud-Synced Trading Journal</p>
                </div>
            </div>
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div class="sync-status">
                    <div class="sync-indicator" id="syncIndicator"></div>
                    <span id="syncStatus">Not Connected</span>
                </div>
                <button class="btn btn-primary" id="authButton" onclick="handleAuthClick()">
                    <span>üîê</span> Connect Google Sheets
                </button>
                <button class="btn btn-success" id="syncButton" onclick="syncToGoogleSheets()" style="display: none;">
                    <span>‚òÅ</span> Sync Now
                </button>
            </div>
        </header>

        <div id="setupInstructions" class="card" style="display: block;">
            <div class="card-header">
                <div class="card-title">üöÄ Setup Required</div>
            </div>
            <div class="alert alert-info">
                <strong>Welcome to Trading Playbook Pro!</strong>
                <p style="margin-top: 10px;">To enable cloud sync, please follow these steps:</p>
            </div>
            <ol style="line-height: 2; color: var(--text-secondary); padding-left: 20px;">
                <li><strong>Click "Connect Google Sheets"</strong> button above</li>
                <li><strong>Sign in</strong> with your Google account</li>
                <li><strong>Grant permissions</strong> to access Google Sheets</li>
                <li>Your data will automatically sync to a Google Sheet</li>
            </ol>
            <div style="margin-top: 20px; padding: 15px; background: rgba(124, 58, 237, 0.1); border-radius: 8px; border-left: 3px solid var(--accent-secondary);">
                <strong>‚ú® Benefits of Cloud Sync:</strong>
                <ul style="margin-top: 10px; line-height: 1.8; color: var(--text-secondary); padding-left: 20px;">
                    <li>Access your trading data from any device</li>
                    <li>Automatic backup to Google Sheets</li>
                    <li>Real-time synchronization</li>
                    <li>100% free - no credit card required</li>
                </ul>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</div>
            <div class="tab" onclick="switchTab('setup')">‚úì Trading Setup</div>
            <div class="tab" onclick="switchTab('trades')">üí∞ My Trades</div>
            <div class="tab" onclick="switchTab('import')">üì• Import from Groww</div>
            <div class="tab" onclick="switchTab('commentary')">üìù Commentary</div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalTrades">0</div>
                    <div class="stat-label">Total Trades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="winRate">0%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPnL">‚Çπ0</div>
                    <div class="stat-label">Total P&L</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgPnL">‚Çπ0</div>
                    <div class="stat-label">Avg P&L per Trade</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìà Recent Activity</div>
                </div>
                <div id="recentActivity">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No recent activity. Start by adding trades or creating a setup checklist.</p>
                </div>
            </div>
        </div>

        <!-- Trading Setup Tab -->
        <div id="setup" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">‚úì Pre-Trade Checklist</div>
                    <button class="btn btn-secondary" onclick="addCustomCheckpoint()">+ Add Custom</button>
                </div>
                <div class="checkbox-group" id="checklistItems">
                    <div class="checkbox-item">
                        <input type="checkbox" id="check1" onchange="saveChecklist()">
                        <label for="check1">Market trend analyzed (Daily/Weekly)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="check2" onchange="saveChecklist()">
                        <label for="check2">Support & Resistance levels marked</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="check3" onchange="saveChecklist()">
                        <label for="check3">Volume profile checked</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="check4" onchange="saveChecklist()">
                        <label for="check4">Risk-reward ratio ‚â• 1:2</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="check5" onchange="saveChecklist()">
                        <label for="check5">Position size calculated</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="check6" onchange="saveChecklist()">
                        <label for="check6">Stop loss defined</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="check7" onchange="saveChecklist()">
                        <label for="check7">Target price set</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="check8" onchange="saveChecklist()">
                        <label for="check8">News/Events checked</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="check9" onchange="saveChecklist()">
                        <label for="check9">Sector analysis done</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="check10" onchange="saveChecklist()">
                        <label for="check10">Emotional state: Calm & Focused</label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">üéØ My Trading Setups</div>
                    <button class="btn btn-primary" onclick="openSetupModal()">+ New Setup</button>
                </div>
                <div id="setupsList">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No trading setups yet. Create your first setup!</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìÖ Active Trade Instances</div>
                    <div style="display: flex; gap: 10px;">
                        <input type="month" id="filterMonth" onchange="filterTradeInstances()" style="width: auto; padding: 8px 12px;">
                        <button class="btn btn-success" onclick="openTradeInstanceModal()">üöÄ Take a New Trade</button>
                    </div>
                </div>
                <div id="tradeInstancesList">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No active trade instances. Click "Take a New Trade" to start!</p>
                </div>
            </div>
        </div>

        <!-- Trades Tab -->
        <div id="trades" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üí∞ Trade History</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="filterTrades('all')">All</button>
                        <button class="btn btn-success" onclick="filterTrades('profit')">Profit</button>
                        <button class="btn btn-danger" onclick="filterTrades('loss')">Loss</button>
                        <button class="btn btn-primary" onclick="openTradeModal()">+ Add Trade</button>
                    </div>
                </div>
                <div class="trade-list" id="tradesList">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No trades recorded. Add your first trade or import from Groww!</p>
                </div>
            </div>
        </div>

        <!-- Import Tab -->
        <div id="import" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üì• Import Trades from Groww</div>
                </div>
                <div class="file-upload" onclick="document.getElementById('growwFile').click()">
                    <input type="file" id="growwFile" accept=".csv,.xlsx" onchange="handleGrowwImport(event)">
                    <div style="font-size: 48px; margin-bottom: 15px;">üìÑ</div>
                    <h3>Click to Upload Groww Trade History</h3>
                    <p style="color: var(--text-secondary); margin-top: 10px;">Supports CSV and Excel files</p>
                </div>
                <div style="margin-top: 20px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 10px;">üìã How to Export from Groww:</h4>
                    <ol style="color: var(--text-secondary); line-height: 2; padding-left: 20px;">
                        <li>Login to your Groww account</li>
                        <li>Go to Portfolio ‚Üí Stocks ‚Üí Order History</li>
                        <li>Click on "Export" or "Download Report"</li>
                        <li>Save the CSV/Excel file</li>
                        <li>Upload it here!</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Commentary Tab -->
        <div id="commentary" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìù Trading Commentary</div>
                    <button class="btn btn-primary" onclick="openCommentaryModal()">+ New Entry</button>
                </div>
                <div id="commentaryList">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No commentary entries yet. Start documenting your trading thoughts!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Modal -->
    <div id="tradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Trade</h2>
                <span class="close-modal" onclick="closeTradeModal()">&times;</span>
            </div>
            <div class="form-group">
                <label>Symbol</label>
                <input type="text" id="tradeSymbol" placeholder="e.g., RELIANCE, TCS">
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Trade Type</label>
                    <select id="tradeType">
                        <option value="BUY">Buy</option>
                        <option value="SELL">Sell</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="tradeQuantity" placeholder="100">
                </div>
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Entry Price</label>
                    <input type="number" step="0.01" id="tradeEntryPrice" placeholder="1250.50">
                </div>
                <div class="form-group">
                    <label>Exit Price (Optional)</label>
                    <input type="number" step="0.01" id="tradeExitPrice" placeholder="1300.75">
                </div>
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Stop Loss</label>
                    <input type="number" step="0.01" id="tradeStopLoss" placeholder="1200.00">
                </div>
                <div class="form-group">
                    <label>Target</label>
                    <input type="number" step="0.01" id="tradeTarget" placeholder="1350.00">
                </div>
            </div>
            <div class="form-group">
                <label>Entry Date</label>
                <input type="date" id="tradeDate">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="tradeNotes" placeholder="Trade reasoning, setup, emotional state..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveTrade()" style="width: 100%;">Save Trade</button>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Trading Setup</h2>
                <span class="close-modal" onclick="closeSetupModal()">&times;</span>
            </div>
            <div class="form-group">
                <label>Setup Name</label>
                <input type="text" id="setupName" placeholder="e.g., Breakout Strategy, Trend Following">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="setupDescription" placeholder="Describe your setup, entry/exit rules..."></textarea>
            </div>
            <div class="form-group">
                <label>Timeframe</label>
                <select id="setupTimeframe">
                    <option value="Intraday">Intraday</option>
                    <option value="Swing">Swing (2-5 days)</option>
                    <option value="Positional">Positional (Weeks/Months)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Entry Criteria (Add each condition separately)</label>
                <div id="entryCriteriaInputs">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="criteriaInput1" placeholder="e.g., Price above 50 EMA" style="flex: 1;">
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="criteriaInput2" placeholder="e.g., RSI above 50">
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="criteriaInput3" placeholder="e.g., Volume breakout">
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addMoreCriteria()" style="width: 100%; margin-top: 10px;">+ Add More Criteria</button>
            </div>
            <button class="btn btn-primary" onclick="saveSetup()" style="width: 100%;">Save Setup</button>
        </div>
    </div>

    <!-- Commentary Modal -->
    <div id="commentaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Commentary Entry</h2>
                <span class="close-modal" onclick="closeCommentaryModal()">&times;</span>
            </div>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="commentaryTitle" placeholder="Market Analysis, Trade Review, etc.">
            </div>
            <div class="form-group">
                <label>Commentary</label>
                <textarea id="commentaryText" style="min-height: 200px;" placeholder="Write your thoughts, market analysis, trade learnings..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveCommentary()" style="width: 100%;">Save Commentary</button>
        </div>
    </div>

    <!-- Trade Instance Modal -->
    <div id="tradeInstanceModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üöÄ Take a New Trade</h2>
                <span class="close-modal" onclick="closeTradeInstanceModal()">&times;</span>
            </div>
            <div class="form-group">
                <label>Select Trading Setup</label>
                <select id="selectedSetupForInstance" onchange="loadSetupCriteria()">
                    <option value="">-- Choose a Setup --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Trade Date</label>
                <input type="date" id="tradeInstanceDate">
            </div>
            <div class="form-group">
                <label>Stock Symbol (Optional)</label>
                <input type="text" id="tradeInstanceSymbol" placeholder="e.g., RELIANCE, TCS">
            </div>
            <div class="form-group">
                <label>Notes (Optional)</label>
                <textarea id="tradeInstanceNotes" placeholder="Additional notes for this trade instance..."></textarea>
            </div>
            <div id="instanceCriteriaContainer" style="display: none;">
                <div style="font-weight: 600; margin: 20px 0 15px 0; color: var(--text-secondary); font-size: 14px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                    ENTRY CRITERIA CHECKLIST:
                </div>
                <div class="entry-criteria-list" id="instanceCriteriaList">
                </div>
                <div id="instanceReadyBadge" style="display: none; margin-top: 20px; padding: 20px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.3)); border-radius: 12px; text-align: center; border: 2px solid var(--accent-success);">
                    <div style="font-size: 24px; font-weight: 700; color: var(--accent-success); margin-bottom: 10px;">
                        ‚úì TRADE IS READY!
                    </div>
                    <div style="color: var(--text-primary);">All entry criteria have been fulfilled. You can proceed with this trade.</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveTradeInstance()" style="width: 100%; margin-top: 20px;">Save Trade Instance</button>
        </div>
    </div>

    <!-- View Trade Instance Modal -->
    <div id="viewTradeInstanceModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üìã Trade Instance Details</h2>
                <span class="close-modal" onclick="closeViewTradeInstanceModal()">&times;</span>
            </div>
            <div id="viewTradeInstanceContent"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

    <!-- Google API -->
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // ===== GOOGLE SHEETS API CONFIGURATION =====
        // TODO: Replace these with your actual values from Google Cloud Console
        const CLIENT_ID = '882695139495-nhsbdo81onntkvla5h0ukq16fatnf392.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBs0O66sO0d8Xy2GeWjYfgnveutSYu8p08';

        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyAg63nq4m6XTNd1CWrdeUKva50Bl_FLIS8",
            authDomain: "trading-playbook-pro.firebaseapp.com",
            projectId: "trading-playbook-pro",
            storageBucket: "trading-playbook-pro.firebasestorage.app",
            messagingSenderId: "201197617062",
            appId: "1:201197617062:web:ab3dbbeaf08ffb1e809967"
        };

        // Initialize Firebase
        let firebaseInitialized = false;
        try {
            firebase.initializeApp(firebaseConfig);
            firebaseInitialized = true;
            console.log("‚úÖ Firebase initialized successfully");
        } catch (error) {
            console.error("‚ùå Firebase initialization error:", error);
        }

        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let spreadsheetId = null;

        // Initialize app data
        let appData = {
            trades: [],
            setups: [],
            commentary: [],
            tradeInstances: [],
            checklist: {},
            settings: {
                spreadsheetId: null,
                lastSync: null
            }
        };

        // Check if we need to show instructions
        function checkSetupStatus() {
            if (CLIENT_ID === 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com') {
                document.getElementById('setupInstructions').style.display = 'block';
                document.getElementById('authButton').disabled = true;
                document.getElementById('authButton').innerHTML = '<span>‚ö†Ô∏è</span> Setup Required';
            } else {
                document.getElementById('setupInstructions').style.display = 'none';
            }
        }

        // Initialize GAPI
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                maybeEnableButtons();
            } catch (error) {
                console.error('Error initializing GAPI:', error);
            }
        }

        // Initialize GIS
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited && CLIENT_ID !== 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com') {
                document.getElementById('authButton').disabled = false;
            }
        }

        // Handle authentication
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                
                updateSyncStatus(true, 'Connected to Google');
                document.getElementById('authButton').style.display = 'none';
                document.getElementById('syncButton').style.display = 'inline-flex';
                
                // Create or get spreadsheet
                await initializeSpreadsheet();
                
                // Initial sync
                await syncToGoogleSheets();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // Update sync status indicator
        function updateSyncStatus(connected, message) {
            const indicator = document.getElementById('syncIndicator');
            const status = document.getElementById('syncStatus');
            
            if (connected) {
                indicator.classList.remove('disconnected');
                status.textContent = message;
            } else {
                indicator.classList.add('disconnected');
                status.textContent = message;
            }
        }

        // Initialize or get existing spreadsheet
        async function initializeSpreadsheet() {
            try {
                // Check if we have a saved spreadsheet ID
                if (appData.settings.spreadsheetId) {
                    spreadsheetId = appData.settings.spreadsheetId;
                    return;
                }

                // Create new spreadsheet
                const response = await gapi.client.sheets.spreadsheets.create({
                    properties: {
                        title: 'Trading Playbook - ' + new Date().toLocaleDateString()
                    },
                    sheets: [
                        {properties: {title: 'Trades'}},
                        {properties: {title: 'Setups'}},
                        {properties: {title: 'Trade Instances'}},
                        {properties: {title: 'Commentary'}}
                    ]
                });

                spreadsheetId = response.result.spreadsheetId;
                appData.settings.spreadsheetId = spreadsheetId;
                saveData();

                showToast('‚úÖ Google Sheet created! Spreadsheet ID: ' + spreadsheetId);
                console.log('Spreadsheet URL:', `https://docs.google.com/spreadsheets/d/${spreadsheetId}`);
                
            } catch (error) {
                console.error('Error creating spreadsheet:', error);
                showToast('Error creating spreadsheet');
            }
        }

        // Sync data to Google Sheets
        async function syncToGoogleSheets() {
            if (!spreadsheetId) {
                showToast('Please connect to Google Sheets first');
                return;
            }

            try {
                showToast('Syncing to Google Sheets...');
                updateSyncStatus(true, 'Syncing...');

                // Prepare trades data
                const tradesData = [
                    ['Symbol', 'Type', 'Quantity', 'Entry Price', 'Exit Price', 'Stop Loss', 'Target', 'Date', 'P&L', 'Status', 'Notes']
                ];
                appData.trades.forEach(trade => {
                    tradesData.push([
                        trade.symbol,
                        trade.type,
                        trade.quantity,
                        trade.entryPrice,
                        trade.exitPrice || '',
                        trade.stopLoss,
                        trade.target,
                        trade.date,
                        trade.pnl,
                        trade.status,
                        trade.notes || ''
                    ]);
                });

                // Prepare setups data
                const setupsData = [
                    ['Name', 'Description', 'Timeframe', 'Criteria Count', 'Created At']
                ];
                appData.setups.forEach(setup => {
                    setupsData.push([
                        setup.name,
                        setup.description || '',
                        setup.timeframe,
                        setup.criteria ? setup.criteria.length : 0,
                        setup.createdAt
                    ]);
                });

                // Prepare trade instances data
                const instancesData = [
                    ['Date', 'Setup Name', 'Symbol', 'Status', 'Progress', 'Notes', 'Criteria Details']
                ];
                appData.tradeInstances.forEach(instance => {
                    const progress = calculateProgress(instance.criteria || []);
                    const criteriaText = (instance.criteria || []).map(c => 
                        `${c.completed ? '‚úì' : '‚òê'} ${c.text}`
                    ).join(' | ');
                    
                    instancesData.push([
                        instance.date,
                        instance.setupName,
                        instance.symbol || 'N/A',
                        instance.isReady ? 'READY' : 'PENDING',
                        `${progress.completed}/${progress.total}`,
                        instance.notes || '',
                        criteriaText
                    ]);
                });

                // Prepare commentary data
                const commentaryData = [
                    ['Title', 'Text', 'Date']
                ];
                appData.commentary.forEach(entry => {
                    commentaryData.push([
                        entry.title,
                        entry.text,
                        new Date(entry.date).toLocaleString()
                    ]);
                });

                // Update all sheets
                await gapi.client.sheets.spreadsheets.values.batchUpdate({
                    spreadsheetId: spreadsheetId,
                    resource: {
                        valueInputOption: 'RAW',
                        data: [
                            {
                                range: 'Trades!A1',
                                values: tradesData
                            },
                            {
                                range: 'Setups!A1',
                                values: setupsData
                            },
                            {
                                range: 'Trade Instances!A1',
                                values: instancesData
                            },
                            {
                                range: 'Commentary!A1',
                                values: commentaryData
                            }
                        ]
                    }
                });

                appData.settings.lastSync = new Date().toISOString();
                saveData();

                updateSyncStatus(true, 'Synced - ' + new Date().toLocaleTimeString());
                showToast('‚úÖ Data synced to Google Sheets!');
                
                console.log('View your sheet:', `https://docs.google.com/spreadsheets/d/${spreadsheetId}`);

            } catch (error) {
                console.error('Error syncing to Google Sheets:', error);
                showToast('‚ùå Error syncing to Google Sheets');
                updateSyncStatus(false, 'Sync Failed');
            }
        }

        // Load from Google Sheets (optional - for loading existing data)
        async function loadFromGoogleSheets() {
            if (!spreadsheetId) return;

            try {
                // Implementation for loading data from sheets if needed
                showToast('Loading from Google Sheets...');
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
            }
        }

        // ===== REST OF THE APP CODE (Same as before) =====
        
        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('tradingPlaybookData');
            if (saved) {
                appData = JSON.parse(saved);
                
                // Ensure all arrays exist
                if (!appData.trades) appData.trades = [];
                if (!appData.setups) appData.setups = [];
                if (!appData.commentary) appData.commentary = [];
                if (!appData.tradeInstances) appData.tradeInstances = [];
                if (!appData.checklist) appData.checklist = {};
                if (!appData.settings) {
                    appData.settings = {
                        spreadsheetId: null,
                        lastSync: null
                    };
                }

                // Restore spreadsheet ID
                spreadsheetId = appData.settings.spreadsheetId;
                
                updateDashboard();
                renderTrades();
                renderSetups();
                renderCommentary();
                renderTradeInstances();
                loadChecklist();

                // If we have a spreadsheet ID and are authenticated, update button
                if (spreadsheetId && gapi.client.getToken()) {
                    document.getElementById('authButton').style.display = 'none';
                    document.getElementById('syncButton').style.display = 'inline-flex';
                    updateSyncStatus(true, 'Connected to Google');
                }
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('tradingPlaybookData', JSON.stringify(appData));
            showToast('Data saved locally!');
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        // Dashboard calculations
        function updateDashboard() {
            const totalTrades = appData.trades.length;
            document.getElementById('totalTrades').textContent = totalTrades;

            if (totalTrades > 0) {
                const profitTrades = appData.trades.filter(t => t.pnl > 0).length;
                const winRate = ((profitTrades / totalTrades) * 100).toFixed(1);
                document.getElementById('winRate').textContent = winRate + '%';

                const totalPnL = appData.trades.reduce((sum, t) => sum + (t.pnl || 0), 0);
                document.getElementById('totalPnL').textContent = '‚Çπ' + totalPnL.toFixed(2);

                const avgPnL = (totalPnL / totalTrades).toFixed(2);
                document.getElementById('avgPnL').textContent = '‚Çπ' + avgPnL;
            }
        }

        // Trade Management
        function openTradeModal() {
            document.getElementById('tradeModal').classList.add('active');
            document.getElementById('tradeDate').valueAsDate = new Date();
        }

        function closeTradeModal() {
            document.getElementById('tradeModal').classList.remove('active');
            clearTradeForm();
        }

        function clearTradeForm() {
            document.getElementById('tradeSymbol').value = '';
            document.getElementById('tradeQuantity').value = '';
            document.getElementById('tradeEntryPrice').value = '';
            document.getElementById('tradeExitPrice').value = '';
            document.getElementById('tradeStopLoss').value = '';
            document.getElementById('tradeTarget').value = '';
            document.getElementById('tradeNotes').value = '';
        }

        function saveTrade() {
            const symbol = document.getElementById('tradeSymbol').value.toUpperCase();
            const type = document.getElementById('tradeType').value;
            const quantity = parseFloat(document.getElementById('tradeQuantity').value);
            const entryPrice = parseFloat(document.getElementById('tradeEntryPrice').value);
            const exitPrice = parseFloat(document.getElementById('tradeExitPrice').value) || null;
            const stopLoss = parseFloat(document.getElementById('tradeStopLoss').value);
            const target = parseFloat(document.getElementById('tradeTarget').value);
            const date = document.getElementById('tradeDate').value;
            const notes = document.getElementById('tradeNotes').value;

            if (!symbol || !quantity || !entryPrice) {
                showToast('Please fill required fields!');
                return;
            }

            let pnl = 0;
            if (exitPrice) {
                pnl = type === 'BUY' 
                    ? (exitPrice - entryPrice) * quantity 
                    : (entryPrice - exitPrice) * quantity;
            }

            const trade = {
                id: Date.now(),
                symbol,
                type,
                quantity,
                entryPrice,
                exitPrice,
                stopLoss,
                target,
                date,
                notes,
                pnl,
                status: exitPrice ? 'CLOSED' : 'OPEN'
            };

            appData.trades.unshift(trade);
            saveData();
            renderTrades();
            updateDashboard();
            closeTradeModal();
            showToast('Trade added successfully!');
        }

        function renderTrades() {
            const container = document.getElementById('tradesList');
            
            if (appData.trades.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No trades recorded. Add your first trade or import from Groww!</p>';
                return;
            }

            container.innerHTML = appData.trades.map(trade => `
                <div class="trade-item">
                    <div class="trade-field">
                        <div class="trade-field-label">Symbol</div>
                        <div class="trade-field-value">${trade.symbol}</div>
                    </div>
                    <div class="trade-field">
                        <div class="trade-field-label">Type</div>
                        <span class="badge badge-${trade.type.toLowerCase()}">${trade.type}</span>
                    </div>
                    <div class="trade-field">
                        <div class="trade-field-label">Quantity</div>
                        <div class="trade-field-value">${trade.quantity}</div>
                    </div>
                    <div class="trade-field">
                        <div class="trade-field-label">Entry Price</div>
                        <div class="trade-field-value">‚Çπ${trade.entryPrice.toFixed(2)}</div>
                    </div>
                    <div class="trade-field">
                        <div class="trade-field-label">Exit Price</div>
                        <div class="trade-field-value">${trade.exitPrice ? '‚Çπ' + trade.exitPrice.toFixed(2) : 'Open'}</div>
                    </div>
                    <div class="trade-field">
                        <div class="trade-field-label">P&L</div>
                        <div class="trade-field-value" style="color: ${trade.pnl >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'}">
                            ${trade.pnl >= 0 ? '+' : ''}‚Çπ${trade.pnl.toFixed(2)}
                        </div>
                    </div>
                    <div class="trade-field">
                        <div class="trade-field-label">Date</div>
                        <div class="trade-field-value">${new Date(trade.date).toLocaleDateString()}</div>
                    </div>
                    <div class="trade-actions">
                        <button class="btn btn-secondary" onclick="deleteTrade(${trade.id})" style="padding: 8px 12px; font-size: 12px;">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteTrade(id) {
            if (confirm('Delete this trade?')) {
                appData.trades = appData.trades.filter(t => t.id !== id);
                saveData();
                renderTrades();
                updateDashboard();
                showToast('Trade deleted!');
            }
        }

        function filterTrades(type) {
            // Implementation for filtering trades
            renderTrades();
        }

        // Setup Management
        let criteriaCounter = 3;

        function openSetupModal() {
            document.getElementById('setupModal').classList.add('active');
            criteriaCounter = 3;
        }

        function closeSetupModal() {
            document.getElementById('setupModal').classList.remove('active');
            document.getElementById('setupName').value = '';
            document.getElementById('setupDescription').value = '';
            document.getElementById('entryCriteriaInputs').innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="criteriaInput1" placeholder="e.g., Price above 50 EMA" style="flex: 1;">
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="criteriaInput2" placeholder="e.g., RSI above 50">
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="criteriaInput3" placeholder="e.g., Volume breakout">
                </div>
            `;
            criteriaCounter = 3;
        }

        function addMoreCriteria() {
            criteriaCounter++;
            const container = document.getElementById('entryCriteriaInputs');
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            div.innerHTML = `<input type="text" id="criteriaInput${criteriaCounter}" placeholder="Enter criteria..." style="flex: 1;">`;
            container.appendChild(div);
        }

        function saveSetup() {
            const name = document.getElementById('setupName').value;
            const description = document.getElementById('setupDescription').value;
            const timeframe = document.getElementById('setupTimeframe').value;

            if (!name) {
                showToast('Please enter setup name!');
                return;
            }

            // Collect all entry criteria
            const criteria = [];
            for (let i = 1; i <= criteriaCounter; i++) {
                const input = document.getElementById('criteriaInput' + i);
                if (input && input.value.trim()) {
                    criteria.push({
                        id: Date.now() + Math.random(),
                        text: input.value.trim(),
                        completed: false
                    });
                }
            }

            if (criteria.length === 0) {
                showToast('Please add at least one entry criteria!');
                return;
            }

            const setup = {
                id: Date.now(),
                name,
                description,
                timeframe,
                criteria: criteria,
                createdAt: new Date().toISOString()
            };

            appData.setups.unshift(setup);
            saveData();
            renderSetups();
            closeSetupModal();
            showToast('Setup saved!');
        }

        function toggleCriteria(setupId, criteriaId) {
            const setup = appData.setups.find(s => s.id === setupId);
            if (setup) {
                const criteria = setup.criteria.find(c => c.id === criteriaId);
                if (criteria) {
                    criteria.completed = !criteria.completed;
                    saveData();
                    renderSetups();
                }
            }
        }

        function addCriteriaToSetup(setupId) {
            const text = prompt('Enter new entry criteria:');
            if (text && text.trim()) {
                const setup = appData.setups.find(s => s.id === setupId);
                if (setup) {
                    setup.criteria.push({
                        id: Date.now(),
                        text: text.trim(),
                        completed: false
                    });
                    saveData();
                    renderSetups();
                    showToast('Criteria added!');
                }
            }
        }

        function deleteCriteria(setupId, criteriaId) {
            const setup = appData.setups.find(s => s.id === setupId);
            if (setup) {
                setup.criteria = setup.criteria.filter(c => c.id !== criteriaId);
                saveData();
                renderSetups();
                showToast('Criteria deleted!');
            }
        }

        function calculateProgress(criteria) {
            if (!criteria || !Array.isArray(criteria)) {
                return { completed: 0, total: 0, percentage: 0 };
            }
            const total = criteria.length;
            const completed = criteria.filter(c => c.completed).length;
            return { completed, total, percentage: total > 0 ? (completed / total) * 100 : 0 };
        }

        function renderSetups() {
            const container = document.getElementById('setupsList');
            
            if (appData.setups.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No trading setups yet. Create your first setup!</p>';
                return;
            }

            container.innerHTML = appData.setups.map(setup => {
                if (!setup.criteria || !Array.isArray(setup.criteria)) {
                    setup.criteria = [];
                }
                
                const progress = calculateProgress(setup.criteria);
                const isReady = progress.completed === progress.total && progress.total > 0;
                
                return `
                <div class="setup-card ${isReady ? 'ready-for-trade' : ''}">
                    <div class="setup-header">
                        <div class="setup-title-section">
                            <h3>${setup.name}</h3>
                            <div class="setup-meta">
                                <span class="badge" style="background: rgba(0, 212, 255, 0.2); color: var(--accent-primary);">${setup.timeframe}</span>
                                <span class="setup-status ${isReady ? 'ready' : 'pending'}">
                                    ${isReady ? '‚úì READY FOR TRADE' : 'PENDING'}
                                </span>
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="deleteSetup(${setup.id})" style="padding: 8px 12px; font-size: 12px;">Delete</button>
                    </div>
                    
                    ${setup.description ? `<p style="color: var(--text-secondary); margin-bottom: 15px;">${setup.description}</p>` : ''}
                    
                    <div class="setup-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress.percentage}%"></div>
                        </div>
                        <div class="progress-text">${progress.completed}/${progress.total}</div>
                    </div>
                    
                    <div style="font-weight: 600; margin-bottom: 10px; color: var(--text-secondary); font-size: 14px;">ENTRY CRITERIA:</div>
                    <div class="entry-criteria-list">
                        ${setup.criteria.map(criteria => `
                            <div class="entry-criteria-item ${criteria.completed ? 'completed' : ''}">
                                <input type="checkbox" 
                                    ${criteria.completed ? 'checked' : ''} 
                                    onchange="toggleCriteria(${setup.id}, ${criteria.id})">
                                <div class="entry-criteria-text">${criteria.text}</div>
                                <span class="criteria-delete" onclick="deleteCriteria(${setup.id}, ${criteria.id})">‚úï</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button class="add-criteria-btn" onclick="addCriteriaToSetup(${setup.id})">
                        + Add Entry Criteria
                    </button>
                </div>
            `}).join('');
        }

        function deleteSetup(id) {
            if (confirm('Delete this setup?')) {
                appData.setups = appData.setups.filter(s => s.id !== id);
                saveData();
                renderSetups();
                showToast('Setup deleted!');
            }
        }

        // Checklist Management
        function saveChecklist() {
            const checkboxes = document.querySelectorAll('#checklistItems input[type="checkbox"]');
            checkboxes.forEach(cb => {
                appData.checklist[cb.id] = cb.checked;
            });
            saveData();
        }

        function loadChecklist() {
            Object.keys(appData.checklist).forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = appData.checklist[id];
                }
            });
        }

        function addCustomCheckpoint() {
            const label = prompt('Enter custom checkpoint:');
            if (label) {
                const id = 'custom_' + Date.now();
                const container = document.getElementById('checklistItems');
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="${id}" onchange="saveChecklist()">
                    <label for="${id}">${label}</label>
                `;
                container.appendChild(div);
                showToast('Checkpoint added!');
            }
        }

        // Commentary Management
        function openCommentaryModal() {
            document.getElementById('commentaryModal').classList.add('active');
        }

        function closeCommentaryModal() {
            document.getElementById('commentaryModal').classList.remove('active');
            document.getElementById('commentaryTitle').value = '';
            document.getElementById('commentaryText').value = '';
        }

        function saveCommentary() {
            const title = document.getElementById('commentaryTitle').value;
            const text = document.getElementById('commentaryText').value;

            if (!title || !text) {
                showToast('Please fill all fields!');
                return;
            }

            const commentary = {
                id: Date.now(),
                title,
                text,
                date: new Date().toISOString()
            };

            appData.commentary.unshift(commentary);
            saveData();
            renderCommentary();
            closeCommentaryModal();
            showToast('Commentary saved!');
        }

        function renderCommentary() {
            const container = document.getElementById('commentaryList');
            
            if (appData.commentary.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No commentary entries yet. Start documenting your trading thoughts!</p>';
                return;
            }

            container.innerHTML = appData.commentary.map(entry => `
                <div class="commentary-entry">
                    <div class="commentary-header">
                        <h3>${entry.title}</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div class="commentary-date">${new Date(entry.date).toLocaleString()}</div>
                            <button class="btn btn-danger" onclick="deleteCommentary(${entry.id})" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                        </div>
                    </div>
                    <div class="commentary-text">${entry.text}</div>
                </div>
            `).join('');
        }

        function deleteCommentary(id) {
            if (confirm('Delete this commentary?')) {
                appData.commentary = appData.commentary.filter(c => c.id !== id);
                saveData();
                renderCommentary();
                showToast('Commentary deleted!');
            }
        }

        // Trade Instance Management
        function openTradeInstanceModal() {
            if (appData.setups.length === 0) {
                showToast('Please create at least one trading setup first!');
                switchTab('setup');
                return;
            }
            
            const select = document.getElementById('selectedSetupForInstance');
            select.innerHTML = '<option value="">-- Choose a Setup --</option>' + 
                appData.setups.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            
            document.getElementById('tradeInstanceDate').valueAsDate = new Date();
            document.getElementById('tradeInstanceSymbol').value = '';
            document.getElementById('tradeInstanceNotes').value = '';
            document.getElementById('instanceCriteriaContainer').style.display = 'none';
            
            document.getElementById('tradeInstanceModal').classList.add('active');
        }

        function closeTradeInstanceModal() {
            document.getElementById('tradeInstanceModal').classList.remove('active');
        }

        function loadSetupCriteria() {
            const setupId = parseInt(document.getElementById('selectedSetupForInstance').value);
            if (!setupId) {
                document.getElementById('instanceCriteriaContainer').style.display = 'none';
                return;
            }

            const setup = appData.setups.find(s => s.id === setupId);
            if (!setup) return;

            if (!setup.criteria || !Array.isArray(setup.criteria)) {
                setup.criteria = [];
            }

            if (setup.criteria.length === 0) {
                showToast('This setup has no entry criteria. Please add criteria first.');
                document.getElementById('instanceCriteriaContainer').style.display = 'none';
                return;
            }

            document.getElementById('instanceCriteriaContainer').style.display = 'block';
            
            const container = document.getElementById('instanceCriteriaList');
            container.innerHTML = setup.criteria.map((criteria, index) => `
                <div class="entry-criteria-item" id="tempCriteria${index}">
                    <input type="checkbox" 
                        id="tempCheck${index}" 
                        onchange="checkInstanceReadiness()">
                    <div class="entry-criteria-text">${criteria.text}</div>
                </div>
            `).join('');

            checkInstanceReadiness();
        }

        function checkInstanceReadiness() {
            const setupId = parseInt(document.getElementById('selectedSetupForInstance').value);
            if (!setupId) return;

            const setup = appData.setups.find(s => s.id === setupId);
            if (!setup || !setup.criteria || !Array.isArray(setup.criteria)) return;

            let allChecked = true;
            for (let i = 0; i < setup.criteria.length; i++) {
                const checkbox = document.getElementById('tempCheck' + i);
                if (checkbox && !checkbox.checked) {
                    allChecked = false;
                    break;
                }
            }

            const badge = document.getElementById('instanceReadyBadge');
            if (allChecked && setup.criteria.length > 0) {
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        function saveTradeInstance() {
            const setupId = parseInt(document.getElementById('selectedSetupForInstance').value);
            const date = document.getElementById('tradeInstanceDate').value;
            const symbol = document.getElementById('tradeInstanceSymbol').value;
            const notes = document.getElementById('tradeInstanceNotes').value;

            if (!setupId) {
                showToast('Please select a trading setup!');
                return;
            }

            if (!date) {
                showToast('Please select a date!');
                return;
            }

            const setup = appData.setups.find(s => s.id === setupId);
            if (!setup) return;

            if (!setup.criteria || !Array.isArray(setup.criteria)) {
                setup.criteria = [];
            }

            if (setup.criteria.length === 0) {
                showToast('This setup has no criteria. Please add criteria to the setup first.');
                return;
            }

            const criteriaStates = setup.criteria.map((criteria, index) => {
                const checkbox = document.getElementById('tempCheck' + index);
                return {
                    id: criteria.id || Date.now() + Math.random(),
                    text: criteria.text,
                    completed: checkbox ? checkbox.checked : false
                };
            });

            const progress = calculateProgress(criteriaStates);
            const isReady = progress.completed === progress.total && progress.total > 0;

            const instance = {
                id: Date.now(),
                setupId: setup.id,
                setupName: setup.name,
                date: date,
                symbol: symbol || 'N/A',
                notes: notes,
                criteria: criteriaStates,
                isReady: isReady,
                createdAt: new Date().toISOString()
            };

            if (!appData.tradeInstances || !Array.isArray(appData.tradeInstances)) {
                appData.tradeInstances = [];
            }

            appData.tradeInstances.unshift(instance);
            saveData();
            renderTradeInstances();
            closeTradeInstanceModal();
            showToast(isReady ? '‚úì Trade instance saved - READY!' : 'Trade instance saved!');
        }

        function renderTradeInstances() {
            const container = document.getElementById('tradeInstancesList');
            
            if (!appData.tradeInstances || appData.tradeInstances.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No active trade instances. Click "Take a New Trade" to start!</p>';
                return;
            }

            const sorted = [...appData.tradeInstances].sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = sorted.map(instance => {
                if (!instance.criteria || !Array.isArray(instance.criteria)) {
                    instance.criteria = [];
                }
                
                const progress = calculateProgress(instance.criteria);
                const dateObj = new Date(instance.date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });

                return `
                <div class="trade-instance-card ${instance.isReady ? 'ready' : ''}">
                    <div class="trade-instance-header">
                        <div class="trade-instance-info">
                            <div class="trade-instance-title">${instance.setupName || 'Unnamed Setup'}</div>
                            <div class="trade-instance-meta">
                                <span class="trade-instance-date">üìÖ ${formattedDate}</span>
                                <span>üìä ${instance.symbol || 'N/A'}</span>
                                <span class="setup-status ${instance.isReady ? 'ready' : 'pending'}">
                                    ${instance.isReady ? '‚úì READY' : 'PENDING'}
                                </span>
                            </div>
                        </div>
                        <div class="trade-instance-actions">
                            <button class="btn btn-primary" onclick="viewTradeInstance(${instance.id})" style="padding: 8px 16px; font-size: 13px;">View</button>
                            <button class="btn btn-danger" onclick="deleteTradeInstance(${instance.id})" style="padding: 8px 16px; font-size: 13px;">Delete</button>
                        </div>
                    </div>
                    <div class="setup-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress.percentage}%"></div>
                        </div>
                        <div class="progress-text">${progress.completed}/${progress.total}</div>
                    </div>
                    ${instance.notes ? `<p style="color: var(--text-secondary); margin-top: 12px; font-size: 14px; font-style: italic;">${instance.notes}</p>` : ''}
                </div>
            `}).join('');
        }

        function viewTradeInstance(id) {
            const instance = appData.tradeInstances.find(i => i.id === id);
            if (!instance) return;

            if (!instance.criteria || !Array.isArray(instance.criteria)) {
                instance.criteria = [];
            }

            const dateObj = new Date(instance.date);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            const progress = calculateProgress(instance.criteria);

            const content = `
                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px;">${instance.setupName || 'Unnamed Setup'}</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                        <span style="color: var(--accent-primary); font-family: 'JetBrains Mono', monospace;">üìÖ ${formattedDate}</span>
                        <span style="color: var(--text-secondary);">üìä ${instance.symbol || 'N/A'}</span>
                        <span class="setup-status ${instance.isReady ? 'ready' : 'pending'}">
                            ${instance.isReady ? '‚úì READY' : 'PENDING'}
                        </span>
                    </div>
                    <div class="setup-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress.percentage}%"></div>
                        </div>
                        <div class="progress-text">${progress.completed}/${progress.total}</div>
                    </div>
                </div>

                ${instance.notes ? `
                    <div style="padding: 15px; background: var(--bg-card); border-radius: 8px; margin-bottom: 20px; border-left: 3px solid var(--accent-primary);">
                        <div style="font-weight: 600; margin-bottom: 5px; color: var(--text-secondary); font-size: 12px;">NOTES:</div>
                        <p style="color: var(--text-primary);">${instance.notes}</p>
                    </div>
                ` : ''}

                <div style="font-weight: 600; margin-bottom: 15px; color: var(--text-secondary); font-size: 14px;">ENTRY CRITERIA:</div>
                <div class="entry-criteria-list">
                    ${instance.criteria.length > 0 ? instance.criteria.map((criteria, index) => `
                        <div class="entry-criteria-item ${criteria.completed ? 'completed' : ''}">
                            <input type="checkbox" 
                                ${criteria.completed ? 'checked' : ''} 
                                onchange="updateInstanceCriteria(${instance.id}, ${index})">
                            <div class="entry-criteria-text">${criteria.text}</div>
                        </div>
                    `).join('') : '<p style="color: var(--text-secondary);">No criteria available</p>'}
                </div>

                ${instance.isReady ? `
                    <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.3)); border-radius: 12px; text-align: center; border: 2px solid var(--accent-success);">
                        <div style="font-size: 24px; font-weight: 700; color: var(--accent-success); margin-bottom: 10px;">
                            ‚úì TRADE IS READY!
                        </div>
                        <div style="color: var(--text-primary);">All entry criteria have been fulfilled. You can proceed with this trade.</div>
                    </div>
                ` : ''}
            `;

            document.getElementById('viewTradeInstanceContent').innerHTML = content;
            document.getElementById('viewTradeInstanceModal').classList.add('active');
        }

        function closeViewTradeInstanceModal() {
            document.getElementById('viewTradeInstanceModal').classList.remove('active');
        }

        function updateInstanceCriteria(instanceId, criteriaIndex) {
            const instance = appData.tradeInstances.find(i => i.id === instanceId);
            if (!instance) return;

            if (!instance.criteria || !Array.isArray(instance.criteria)) {
                instance.criteria = [];
                saveData();
                return;
            }

            if (criteriaIndex >= instance.criteria.length) return;

            instance.criteria[criteriaIndex].completed = !instance.criteria[criteriaIndex].completed;

            const progress = calculateProgress(instance.criteria);
            instance.isReady = progress.completed === progress.total && progress.total > 0;

            saveData();
            renderTradeInstances();
            viewTradeInstance(instanceId);
            
            if (instance.isReady) {
                showToast('‚úì All criteria complete - Trade is ready!');
            }
        }

        function deleteTradeInstance(id) {
            if (confirm('Delete this trade instance?')) {
                appData.tradeInstances = appData.tradeInstances.filter(i => i.id !== id);
                saveData();
                renderTradeInstances();
                showToast('Trade instance deleted!');
            }
        }

        function filterTradeInstances() {
            const filterMonth = document.getElementById('filterMonth').value;
            if (!filterMonth) {
                renderTradeInstances();
                return;
            }

            const [year, month] = filterMonth.split('-');
            const filtered = appData.tradeInstances.filter(instance => {
                const instanceDate = new Date(instance.date);
                return instanceDate.getFullYear() === parseInt(year) && 
                       (instanceDate.getMonth() + 1) === parseInt(month);
            });

            // Re-render with filtered data
            // (Implementation similar to renderTradeInstances)
        }

        // Groww Import
        function handleGrowwImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    jsonData.forEach(row => {
                        const trade = {
                            id: Date.now() + Math.random(),
                            symbol: row['Symbol'] || row['Stock'],
                            type: (row['Type'] || row['Trade Type'] || '').toUpperCase(),
                            quantity: parseFloat(row['Quantity'] || row['Qty'] || 0),
                            entryPrice: parseFloat(row['Price'] || row['Buy Price'] || 0),
                            exitPrice: parseFloat(row['Sell Price']) || null,
                            date: row['Date'] || new Date().toISOString().split('T')[0],
                            notes: 'Imported from Groww',
                            pnl: parseFloat(row['P&L'] || row['Profit/Loss'] || 0),
                            status: row['Status'] || 'CLOSED'
                        };
                        appData.trades.unshift(trade);
                    });

                    saveData();
                    renderTrades();
                    updateDashboard();
                    showToast(`Imported ${jsonData.length} trades successfully!`);
                } catch (error) {
                    showToast('Error importing file. Please check format.');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Initialize app
        window.onload = function() {
            checkSetupStatus();
            loadData();
            
            // Load Google API
            if (typeof gapi !== 'undefined') {
                gapiLoaded();
            }
            if (typeof google !== 'undefined') {
                gisLoaded();
            }
        };
    </script>
</body>
</html>
